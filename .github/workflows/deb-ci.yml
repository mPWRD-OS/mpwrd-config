name: Build Debian Package (CI)

on:
  push:
    branches:
      - developer
  pull_request:
    branches:
      - main

jobs:
  build-deb:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            debhelper \
            devscripts \
            dh-python \
            python3 \
            python3-build \
            python3-venv

      - name: Stamp CI version
        run: |
          BASE_VERSION=$(dpkg-parsechangelog -SVersion)
          DATE=$(date -u +%Y%m%d)
          SHA=${GITHUB_SHA::7}
          CI_VERSION="${BASE_VERSION}+git${DATE}.${SHA}"
          export BASE_VERSION DATE SHA CI_VERSION
          python - <<'PY'
          import os
          import re
          from pathlib import Path
          base = os.environ["BASE_VERSION"]
          date = os.environ["DATE"]
          sha = os.environ["SHA"]
          ci = os.environ["CI_VERSION"]
          changelog = Path("debian/changelog")
          text = changelog.read_text(encoding="utf-8")
          text = re.sub(r"^(mpwrd-config \\()[^)]+(\\))", r"\\1" + ci + r"\\2", text, count=1, flags=re.M)
          changelog.write_text(text, encoding="utf-8")
          upstream = base.rsplit("-", 1)[0] if "-" in base else base
          pep = f"{upstream}+git{date}.{sha}"
          setup_cfg = Path("setup.cfg")
          setup_text = setup_cfg.read_text(encoding="utf-8")
          setup_text = re.sub(r"^version\\s*=\\s*.+$", f"version = {pep}", setup_text, flags=re.M)
          setup_cfg.write_text(setup_text, encoding="utf-8")
          print(f"Stamped CI version: {ci} (python {pep})")
          PY

      - name: Build deb
        run: |
          dpkg-buildpackage -us -uc -b
          rm -rf build-artifacts
          mkdir -p build-artifacts
          mv ../mpwrd-config_* build-artifacts/

      - name: Upload deb artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mpwrd-config-deb
          path: build-artifacts/*
